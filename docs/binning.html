<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>5 Binning | Protocol for metagenomic analyses</title>
  <meta name="description" content="5 Binning | Protocol for metagenomic analyses" />
  <meta name="generator" content="bookdown 0.35 and GitBook 2.6.7" />

  <meta property="og:title" content="5 Binning | Protocol for metagenomic analyses" />
  <meta property="og:type" content="book" />
  
  
  <meta name="github-repo" content="rstudio/bookdown-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="5 Binning | Protocol for metagenomic analyses" />
  
  
  

<meta name="author" content="Karine Villeneuve" />


<meta name="date" content="2024-09-17" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="barrnap.html"/>
<link rel="next" href="metabolic-pathway.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="toc.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Metagenomic sequencing data analysis</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="pre-process.html"><a href="pre-process.html"><i class="fa fa-check"></i><b>2</b> Pre-process</a></li>
<li class="chapter" data-level="3" data-path="assembly-spades.html"><a href="assembly-spades.html"><i class="fa fa-check"></i><b>3</b> Assembly SPAdes</a></li>
<li class="chapter" data-level="4" data-path="barrnap.html"><a href="barrnap.html"><i class="fa fa-check"></i><b>4</b> Barrnap</a></li>
<li class="chapter" data-level="5" data-path="binning.html"><a href="binning.html"><i class="fa fa-check"></i><b>5</b> Binning</a></li>
<li class="chapter" data-level="6" data-path="metabolic-pathway.html"><a href="metabolic-pathway.html"><i class="fa fa-check"></i><b>6</b> Metabolic pathway</a></li>
<li class="chapter" data-level="7" data-path="phylogenetic-tree.html"><a href="phylogenetic-tree.html"><i class="fa fa-check"></i><b>7</b> Phylogenetic tree</a></li>
<li class="chapter" data-level="8" data-path="viromes.html"><a href="viromes.html"><i class="fa fa-check"></i><b>8</b> Viromes</a></li>
<li class="chapter" data-level="9" data-path="using-nohup-and-other-tips-and-tricks.html"><a href="using-nohup-and-other-tips-and-tricks.html"><i class="fa fa-check"></i><b>9</b> Using nohup and other tips and tricks</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Protocol for metagenomic analyses</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="binning" class="section level1 hasAnchor" number="5">
<h1><span class="header-section-number">5</span> Binning<a href="binning.html#binning" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>In metagenomics, binning is the process of grouping reads or contigs and assigning them to individual genome known as Metagenome Assembled Genome (MAG). Coverage-based binning approaches will require you to map reads to assembled contigs.</p>
<p><a href="https://bitbucket.org/berkeleylab/metabat/wiki/Home">Comparision of different binning tools</a></p>
<p><strong>1. Mapping</strong></p>
<p>Mapping allows you to get a rough count of the total number of reads mapping to each contig, also referred to as the depth file or read coverage. This information is required for most binning algorithm. Raw reads from each sample are mapped to the contigs (assembled reads).The idea being that if two contigs come from the same genome in your sample, so the same organism, then they would have been sequenced roughly to the same depth, they would have a similar coverage and they go together. It gets even better if you have multiple samples that vary a bit and you sequence all of them. You do your assembly on one of the samples, then you can take the reads from the other samples, map to that genome (metagenomic assembly) and you can use that as additional information.</p>
<p>Different tools exists for mapping reads to genomic sequences. Here we are using <a href="https://github.com/imrambo/genome_mapping">Scons Wrapper</a> which maps FASTQ reads against an assembly (e.g. genome) in FASTA format using BWA-MEM. This wrapper does not produce huge intermediate files (e.g. unfiltered SAM).</p>
<p><font color='red'>I am currently looking for a way to loop this. Tried specifying only the input folder and the sampleids as proposed in the README but it does not work. Therefore these steps must be repeated for every sample. .</font></p>
<p>For each sample, create a new folder in the directory <code>05_binning</code> and inside each folder copy the filtered assembled contigs FASTA and the interleaved-trimed FASTQ for that sample.</p>
<ol style="list-style-type: lower-alpha">
<li>Activate the scons_maps conda environment</li>
</ol>
<div class="sourceCode" id="cb26"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb26-1"><a href="binning.html#cb26-1" tabindex="-1"></a><span class="ex">conda</span> activate scons_map</span></code></pre></div>
<ol start="2" style="list-style-type: lower-alpha">
<li>Execute scons from the <code>genome_mapping</code> directory (<code>/home/genomics/genome_mapping</code>). Modify the following parameters accordingly :</li>
</ol>
<ul>
<li><code>--fastq_dir</code> = directory where the filtered assembled contigs FASTA and the interleaved-trimed FASTQ files are.</li>
<li><code>--assembly</code> = path to the filtered contig FASTA files including the name of the file at the end.</li>
<li><code>--sampleids</code> = name of the interleave.trim.fastq.</li>
</ul>
<div class="sourceCode" id="cb27"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb27-1"><a href="binning.html#cb27-1" tabindex="-1"></a><span class="ex">scons</span> <span class="at">--fastq_dir</span><span class="op">=</span>/home/genomics/user/05_binning/sample_01/ <span class="at">--assembly</span><span class="op">=</span>/home/genomics/user/05_binning/sample_01/1kb_sample_01_contigs.fasta <span class="at">--outdir</span><span class="op">=</span>/home/genomics/user/05_binning/sample_01/output <span class="at">--sampleids</span><span class="op">=</span>sample_01.fastq.interleave.fastq.trim.fastq <span class="at">--align_thread</span><span class="op">=</span>5 <span class="at">--samsort_thread</span><span class="op">=</span>5 <span class="at">--samsort_mem</span><span class="op">=</span>768M <span class="at">--nheader</span><span class="op">=</span>0 <span class="at">--tmpdir</span><span class="op">=</span>/home/genomics/tmp <span class="at">--logfile</span><span class="op">=</span>mapping.log</span></code></pre></div>
<p>In the specified output directory you will find a <code>.sorted.bam</code> which contains the depth information required by <code>MetaBAT2</code>. Create a directory call <code>sorted_bam</code> and move all the <code>sorted.bam</code> files into this directory.</p>
<p><strong>2. Depth file</strong></p>
<p>The depth allows you to know how many sequence you can align with certain sections of your contigs. Section with very little depth (few sequences) are not reputable to use. We use the script <code>jgi_summarize_bam_contig_depths</code>.</p>
<ol style="list-style-type: lower-alpha">
<li>From the directory <code>sorted_bam</code> create a bash script called <code>run_depthfile.sh</code> with the following commands and execute the script using nohup.</li>
</ol>
<div class="sourceCode" id="cb28"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb28-1"><a href="binning.html#cb28-1" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb28-2"><a href="binning.html#cb28-2" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="pp">*</span>.sorted.bam</span>
<span id="cb28-3"><a href="binning.html#cb28-3" tabindex="-1"></a>  <span class="cf">do</span> <span class="ex">/home/SCRIPT/jgi_summarize_bam_contig_depths</span> <span class="at">--outputDepth</span> <span class="va">$i</span>.depth.txt <span class="at">--pairedContigs</span> <span class="va">$i</span>.paired.txt <span class="va">$i</span></span>
<span id="cb28-4"><a href="binning.html#cb28-4" tabindex="-1"></a><span class="cf">done</span> </span></code></pre></div>
<ul>
<li><strong>Output</strong> : For each given file the script generates a file ending with <code>.depth.txt</code> as output.</li>
<li>Move these files into a directory call <code>metabat2</code> and also copy into this folder the filtered contig FASTA.</li>
</ul>
<p><strong>3. Create bins</strong></p>
<p><a href="https://bitbucket.org/berkeleylab/metabat/src/master/">MetaBAT2</a> is an efficient tool for accurately reconstructing single genomes from complex microbial communities.</p>
<ol style="list-style-type: lower-alpha">
<li>If required, first deactivate <code>scons_map</code> and then activate conda.</li>
</ol>
<div class="sourceCode" id="cb29"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb29-1"><a href="binning.html#cb29-1" tabindex="-1"></a><span class="ex">conda</span> deactivate</span>
<span id="cb29-2"><a href="binning.html#cb29-2" tabindex="-1"></a><span class="ex">conda</span> activate</span></code></pre></div>
<ol start="2" style="list-style-type: lower-alpha">
<li>In order to be able to loop this for throught all samples, the name of filtered contig FASTA file must match exactly the beginning of the depths file. Example :</li>
</ol>
<ul>
<li>Filtered contig FASTA : <code>1kb_sample_01_contigs.fasta</code></li>
<li>Depth file : <code>1kb_sample_01_contigs.fasta.depth.txt</code></li>
</ul>
<ol start="3" style="list-style-type: lower-alpha">
<li>Create a bash script called <code>run_metabat2.sh</code> with the following commands and execute the script using nohup.</li>
</ol>
<div class="sourceCode" id="cb30"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb30-1"><a href="binning.html#cb30-1" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb30-2"><a href="binning.html#cb30-2" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="pp">*</span>.fasta</span>
<span id="cb30-3"><a href="binning.html#cb30-3" tabindex="-1"></a>  <span class="cf">do</span> <span class="ex">metabat2</span> <span class="at">-i</span> <span class="va">$i</span> <span class="at">-a</span> <span class="va">$i</span>.depth.txt <span class="at">-o</span> bins_<span class="va">$i</span> <span class="at">-t</span> 0 <span class="at">--minCVSum</span> 0 <span class="at">--saveCls</span> <span class="at">-d</span> <span class="at">-v</span> <span class="at">--minCV</span> 0.1 <span class="at">-m</span> 1000</span>
<span id="cb30-4"><a href="binning.html#cb30-4" tabindex="-1"></a><span class="cf">done</span> </span></code></pre></div>
<ul>
<li><strong>Output</strong> - for each given file metabat2 generates a directory containing all the bins created.</li>
</ul>
<p><strong>4. Check quality</strong></p>
<p><a href="https://github.com/Ecogenomics/CheckM/wiki">Checkm</a></p>
<p><strong>You have to go back one folder in the terminal as checkm will run on all the files in the folder you give it as input. Checkm will automatically create a folder called checkm in the specified directory, therefor if you must run checkm again make sure to delete the newly created checkm folder, otherwise checkm will give you an error message.</strong></p>
<ol style="list-style-type: lower-alpha">
<li>Activate the environment</li>
</ol>
<div class="sourceCode" id="cb31"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb31-1"><a href="binning.html#cb31-1" tabindex="-1"></a><span class="ex">conda</span> activate checkm</span></code></pre></div>
<ol start="2" style="list-style-type: lower-alpha">
<li>Create a bash script called <code>run_checkm.sh</code> with the following commands and execute the script using nohup.</li>
</ol>
<div class="sourceCode" id="cb32"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb32-1"><a href="binning.html#cb32-1" tabindex="-1"></a><span class="ex">checkm</span> lineage_wf <span class="at">-x</span> fa 2kbp_bins/ 2kbp_bins/checkm <span class="at">-f</span> 2kbp_bins/output.txt <span class="at">-t</span> 48 </span></code></pre></div>
<ol style="list-style-type: lower-alpha">
<li><p>Open the <code>output.txt</code> document with excel to verify the <strong>completeness</strong> and <strong>contamination</strong> of your bins.
<strong>Standard : Completeness &gt; 50 % and Contamination &lt; 10 %</strong></p></li>
<li><p>Remove all the spaces with <code>control</code> + <code>H</code></p></li>
<li><p>Filter the columns by Completeness, and separate the ones &lt; 50 % by adding a line in excel</p></li>
<li><p>Filter by Contamination, and highlight all the ones &gt; 10 % - These are the bins you want to clean</p></li>
</ol>
<p><strong>5. Metagenome assembled genome statistics</strong></p>
<p><a href="">Quast</a></p>
<div class="sourceCode" id="cb33"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb33-1"><a href="binning.html#cb33-1" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb33-2"><a href="binning.html#cb33-2" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="pp">*</span>.fa</span>
<span id="cb33-3"><a href="binning.html#cb33-3" tabindex="-1"></a>  <span class="cf">do</span>  <span class="ex">python</span> /home/genomics/quast-5.2.0/quast.py <span class="va">$i</span> <span class="at">-o</span> /home/genomics/karine/stleonard/E4-2/quast_out/<span class="va">$i</span> <span class="at">--threads</span> 48 <span class="at">--no-check</span> <span class="at">--no-plots</span> <span class="at">--no-html</span> <span class="at">--no-icarus</span></span>
<span id="cb33-4"><a href="binning.html#cb33-4" tabindex="-1"></a><span class="cf">done</span></span></code></pre></div>
<div class="sourceCode" id="cb34"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb34-1"><a href="binning.html#cb34-1" tabindex="-1"></a><span class="cf">for</span> folder <span class="kw">in</span> <span class="pp">*</span><span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb34-2"><a href="binning.html#cb34-2" tabindex="-1"></a>    <span class="kw">(</span><span class="bu">cd</span> <span class="st">&quot;</span><span class="va">$folder</span><span class="st">&quot;</span> <span class="kw">&amp;&amp;</span> <span class="ex">report.txt</span><span class="kw">)</span>  </span>
<span id="cb34-3"><a href="binning.html#cb34-3" tabindex="-1"></a>    <span class="fu">mv</span> <span class="st">&quot;</span><span class="va">$folder</span><span class="st">/report.txt&quot;</span> <span class="st">&quot;</span><span class="va">${folder}</span><span class="st">_report.txt&quot;</span></span>
<span id="cb34-4"><a href="binning.html#cb34-4" tabindex="-1"></a><span class="cf">done</span></span></code></pre></div>
<p><strong>6. Taxonomy</strong></p>
<p><a href="https://github.com/Ecogenomics/GTDBTk">GTDBTK</a></p>
<p>Activate the GTDBTK environment</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb35-1"><a href="binning.html#cb35-1" tabindex="-1"></a><span class="ex">conda</span> activate gtdbtk-2.4.0</span></code></pre></div>
<p>In the folder with all your clean and completed genomes run this command with nohup</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb36-1"><a href="binning.html#cb36-1" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb36-2"><a href="binning.html#cb36-2" tabindex="-1"></a><span class="ex">gtdbtk</span> classify_wf <span class="at">--cpus</span> 20 <span class="at">--genome_dir</span> /home/genomics/06_mags/ <span class="at">--out_dir</span> /home/genomics/06_mags/gtdbk_output <span class="at">-x</span> fa</span></code></pre></div>
<p>Once it is done running, you can open the folder called <code>gtdbk_output</code> and copy the file <code>gtdbtk.bac120.summary.tsv</code> to your local computer in order to open it with excel.</p>

</div>
            </section>

          </div>
        </div>
      </div>
<a href="barrnap.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="metabolic-pathway.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": null,
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/rstudio/bookdown-demo/edit/master/03_binning.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
